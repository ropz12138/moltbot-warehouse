# Lark Plugin for Clawdbot

A channel plugin that enables Clawdbot to communicate via Lark (Larksuite) messaging platform.

## Features

- **Direct Messages**: Chat with your bot one-on-one
- **Group Chats**: Add your bot to group conversations
- **Text Messages**: Send and receive text messages
- **Image Support**: Bot can send images generated by agents
- **Webhook Mode**: For individual Lark accounts (tested)
- **WebSocket Mode**: For enterprise accounts (experimental, not fully tested)
- **Auto-Recovery**: Webhook server automatically restarts on crashes

## Requirements

- Clawdbot installed and configured
- A Lark Developer account
- A Lark app with Bot capability enabled

## Installation

```bash
# Clone the repository
git clone https://github.com/sugarforever/moltbot-warehouse.git
cd moltbot-warehouse/extensions/lark

# Install dependencies
npm install

# Install plugin into Clawdbot
clawdbot plugins install --link .
```

Verify installation:

```bash
clawdbot plugins list
```

You should see `lark` with status `loaded`.

## Lark App Setup

1. Go to [Lark Developer Console](https://open.larksuite.com/app)

2. Create a new app or use an existing one

3. Enable **Bot** capability under App Features

4. Add the following permissions under Permissions & Scopes:
   - `im:message` - Send messages
   - `im:chat:readonly` - Read chat info
   - `im:resource` - Upload images (required for image support)

5. Note your **App ID** and **App Secret** from Credentials & Basic Info (you'll need these for configuration)

6. Publish your app under Version Management

## Configuration

### Using Config Commands

```bash
# Required settings
clawdbot config set channels.lark.accounts.default.appId 'cli_xxxxx'
clawdbot config set channels.lark.accounts.default.appSecret 'your-app-secret'
clawdbot config set channels.lark.accounts.default.connectionMode 'webhook'

# Optional settings
clawdbot config set channels.lark.accounts.default.webhookPort 3000
clawdbot config set channels.lark.accounts.default.domain 'lark'
clawdbot config set channels.lark.accounts.default.dmPolicy 'open'
clawdbot config set channels.lark.accounts.default.groupPolicy 'open'
clawdbot config set channels.lark.accounts.default.groupMentionGated false

# Security settings (from Lark Developer Console > Events & Callbacks > Encryption Strategy)
clawdbot config set channels.lark.accounts.default.encryptKey 'your-encrypt-key'
clawdbot config set channels.lark.accounts.default.verificationToken 'your-verification-token'
```

### Using Environment Variables

For the default account, you can use environment variables:

```bash
LARK_APP_ID=cli_xxxxx
LARK_APP_SECRET=your-app-secret

# Security settings (from Lark Developer Console > Events & Callbacks > Encryption Strategy)
LARK_ENCRYPT_KEY=your-encrypt-key          # Optional, for decrypting event payloads
LARK_VERIFICATION_TOKEN=your-token         # Optional, for verifying request authenticity
```

### Configuration Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `appId` | string | - | Lark App ID (required) |
| `appSecret` | string | - | Lark App Secret (required) |
| `connectionMode` | string | `websocket` | `webhook` or `websocket` |
| `webhookPort` | number | `3000` | Port for webhook server |
| `domain` | string | `lark` | `lark` (international) or `feishu` (China) |
| `encryptKey` | string | - | Encrypt key for decrypting event payloads (from Events & Callbacks > Encryption Strategy) |
| `verificationToken` | string | - | Token for verifying request authenticity (from Events & Callbacks > Encryption Strategy) |
| `dmPolicy` | string | `pairing` | `open`, `pairing`, or `allowlist` |
| `groupPolicy` | string | `open` | `open`, `allowlist`, or `disabled` |
| `groupMentionGated` | boolean | `true` | Require @mention in groups |

## Webhook Mode Setup

Webhook mode is recommended for individual Lark accounts.

> **Security & Privacy Notice**: ngrok exposes your local server to the internet. Keep the following in mind:
> - Never share your ngrok URL publicly â€” anyone with the URL can send requests to your local machine
> - Use a paid ngrok plan with authentication or IP restrictions for production use
> - Stop ngrok when not in use to close the tunnel
> - Consider using Lark's `encryptKey` and `verificationToken` for additional request validation
> - For production deployments, use a proper reverse proxy with HTTPS on your own infrastructure instead of ngrok

1. Start ngrok to expose your local webhook server:

```bash
ngrok http 3000
```

2. Copy the HTTPS URL from ngrok (e.g., `https://abc123.ngrok.io`)

3. Configure Events & Callbacks in Lark Developer Console:
   - Add event subscription: `im.message.receive_v1`
   - Set Request URL to your ngrok HTTPS URL (e.g., `https://abc123.ngrok.io`)

4. Start Clawdbot:

```bash
clawdbot start
```

5. The webhook server will start automatically and handle URL verification

## WebSocket Mode

WebSocket mode is available for enterprise Lark accounts that support long connections. Set `connectionMode` to `websocket`:

```bash
clawdbot config set channels.lark.accounts.default.connectionMode 'websocket'
```

> **Note**: WebSocket mode has not been fully tested. If you encounter issues, please use webhook mode or submit a bug report.

## Multiple Accounts

You can configure multiple Lark accounts:

```bash
clawdbot config set channels.lark.accounts.work.appId 'cli_work_app'
clawdbot config set channels.lark.accounts.work.appSecret 'work-secret'
clawdbot config set channels.lark.accounts.personal.appId 'cli_personal_app'
clawdbot config set channels.lark.accounts.personal.appSecret 'personal-secret'
```

## Troubleshooting

### Bot not receiving messages

1. Verify the event subscription `im.message.receive_v1` is added
2. Check that the callback URL is correctly configured
3. Ensure the required permissions are enabled
4. Make sure the app is published (not just saved as draft)

### Permission errors when sending images

Add the `im:resource` permission in Lark Developer Console and republish your app.

### Webhook server not starting

Check if port 3000 is already in use. Change the port:

```bash
clawdbot config set channels.lark.accounts.default.webhookPort 3001
```

### Connection issues with WebSocket mode

WebSocket mode requires enterprise Lark accounts. If you have an individual account, use webhook mode instead.

## Contributing

Issues and pull requests are welcome! If you encounter bugs or have feature requests, please open an issue on this repository.

## License

MIT
